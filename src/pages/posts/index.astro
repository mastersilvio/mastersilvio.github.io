---
import Layout from '@/layouts/Layout.astro';
import PostCard from '@/components/PostCard.svelte';
import Breadcrumbs from '@/components/Breadcrumbs.svelte';
import { getReadTime } from '@/lib/utils/readTime';
import { getPublishedPosts, getPostSlug } from '@/lib/utils/posts';
import { SITE } from '@/config';
import { getBreadcrumbSchema } from '@/lib/schemas';
import I18nLabel from '@/components/I18nLabel.astro';

const schema = getBreadcrumbSchema([
  { name: 'Blog', url: new URL('/posts', Astro.site).toString() },
]);

const posts = (await getPublishedPosts()).sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// Group posts by year
const groupedPosts = posts.reduce(
  (acc, post) => {
    const year = post.data.pubDate.getFullYear().toString();
    if (!acc[year]) acc[year] = [];
    acc[year].push(post);
    return acc;
  },
  {} as Record<string, typeof posts>
);

const years = Object.keys(groupedPosts).sort((a, b) => b.localeCompare(a));

// Get tags grouped by language
type TagEntry = { tag: string; count: number; lang: string };
const tagsByLang: TagEntry[] = [];

for (const lang of ['pt', 'en', 'es']) {
  const langPosts = posts.filter((p) => (p.data.lang || 'en') === lang);
  const counts: Record<string, number> = {};
  langPosts.forEach((p) => p.data.tags?.forEach((t) => { counts[t] = (counts[t] || 0) + 1; }));
  Object.entries(counts)
    .sort(([, a], [, b]) => b - a)
    .slice(0, 15)
    .forEach(([tag, count]) => tagsByLang.push({ tag, count, lang }));
}
---

<Layout title="Blog" description={SITE.blogDescription} schema={schema}>
  <Breadcrumbs items={[{ name: 'Blog', href: '/posts' }]} />

  <div class="mb-10 sm:mb-12">
    <I18nLabel k="allPosts" tag="h1" class="text-3xl sm:text-4xl lg:text-5xl font-black tracking-tight text-foreground leading-[1.1]" />
    <p class="mt-3 text-base sm:text-lg text-muted-foreground max-w-2xl leading-relaxed">
      {SITE.blogDescription}
    </p>
  </div>

  <div class="flex flex-col lg:flex-row gap-10 lg:gap-12">
    <!-- Main Content: Posts -->
    <div class="flex-1 min-w-0">
      <div class="flex flex-col gap-12 lg:gap-14">
        {
          years.map((year) => (
            <section class="flex flex-col gap-6" data-year-section>
              <div class="flex items-center gap-6">
                <h2 class="text-xs font-black uppercase tracking-[0.25em] text-muted-foreground opacity-80 shrink-0">
                  {year}
                </h2>
                <div class="h-px flex-1 bg-border opacity-60" />
              </div>
              <div class="flex flex-col gap-3 sm:gap-4">
                {groupedPosts[year].map((post) => (
                  <PostCard
                    {post}
                    slug={getPostSlug(post)}
                    readTime={getReadTime(post.body || '')}
                  />
                ))}
              </div>
            </section>
          ))
        }
      </div>
    </div>

    <!-- Sidebar: Tags -->
    <aside class="lg:w-64 flex-shrink-0">
      <div class="lg:sticky lg:top-24">
        <div class="p-5 rounded-xl bg-secondary/30 border border-border/50">
          <I18nLabel k="popularTopics" tag="h3" class="text-xs font-bold uppercase tracking-widest text-muted-foreground mb-4" />
          <div class="flex flex-wrap gap-2">
            {
              tagsByLang.map(({ tag, count, lang }) => (
                <a
                  href={`/posts/tag/${tag}`}
                  data-post-lang={lang}
                  class="inline-flex items-center gap-1.5 px-2.5 py-1.5 rounded-lg text-xs font-medium bg-background border border-border hover:bg-accent hover:border-primary/50 transition-all no-underline group"
                >
                  <span class="text-foreground group-hover:text-primary transition-colors">
                    {tag}
                  </span>
                  <span class="text-muted-foreground text-xs">({count})</span>
                </a>
              ))
            }
          </div>
        </div>
      </div>
    </aside>
  </div>
</Layout>
